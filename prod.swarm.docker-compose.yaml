services:
  fastapi_backend_project_job:
    image: arturscibor/praca.server.arturscibor.pl:latest
    env_file:
      - env/prod.env
    volumes:
      - .:/app
    networks:
      - traefik-public
    deploy:
      replicas: 1  # <- 2 repliki
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.praca.rule=Host(`praca.server.arturscibor.pl`)"
        - "traefik.http.routers.praca.entrypoints=websecure"
        - "traefik.http.routers.praca.tls.certresolver=myresolver"
        # Retry middleware
        - "traefik.http.middlewares.retryme.retry.attempts=3"
        - "traefik.http.routers.praca.middlewares=retryme"
        # Port aplikacji
        - "traefik.http.services.praca.loadbalancer.server.port=3000"
        # Healthcheck
        - "traefik.http.services.praca.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.praca.loadbalancer.healthcheck.interval=10s"
        - "traefik.http.services.praca.loadbalancer.healthcheck.timeout=5s"

networks:
  traefik-public:
    external: true
